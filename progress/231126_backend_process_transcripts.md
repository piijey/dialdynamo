# process_transcript
`backend/process_transcripts.py` のドキュメント（2023/11/26）

## 全体の中での位置付け
タイムアウトは2種類設定している。

- **フロントエンド（クライアント）のタイムアウト（3秒）**： transcript が一定時間以上更新されない場合に、transcript をサーバへ送信してリセットする（保持・送信する transcript の長さを抑えるため）
- **バックエンド（サーバ）側のタイムアウト（0.5秒）**： transcript を確定し、それに基づいて応答生成を開始する

もしフロントエンド側で短時間（0.5秒とか）のタイムアウトを設定すると、 transcript のリセット・webscoket送信・次の入力に備える… の実行タイミングのずれが問題になる（Reactが値更新を非同期で行うため）。それを避けフロントエンド側での処理を単純にするために、短時間での transcript 確定はバックエンド側で行うことにした。

## バックエンドでの transcript 確定
`backend/process_transcripts.py` `process` では、フロントエンド（クライアント）から送信された書き起こしテキスト (transcript) をタイムアウトに基づいて確定する。

1. `get_segment` で、前回受信した transcript との時間差がタイムアウト時間 (`USER_TIMEOUT`) 以上であれば、確定テキストありと判断する
2. 確定履歴 (`message_list`) に基づいて、前回受信した transcript から「新たに追加された文字列」を抜きだし、確定テキスト `segment` とする

## 例
フロントエンド（クライアント）から送信された `timestamp` と `transcript` の組、前回の受信との時間差 `time_diff` と確定テキスト `segment` を表にまとめた。この例では、タイムアウト（ユーザ入力テキストメッセージを自動的に区切るための閾値）を、0.5 秒に設定している。

|`timestamp`|`transcript` (文字起こしテキスト)|`time_diff` (前回との時間差)|`segment` (確定テキスト)|
|:----|:----|:----|:----|
|2023-11-18T09:14:02.944Z|初| | |
|2023-11-18T09:14:02.962Z|初め|0:00:00.018| |
|2023-11-18T09:14:03.014Z|初め ま|0:00:00.052| |
|2023-11-18T09:14:03.231Z|初めまして|0:00:00.217| |
|2023-11-18T09:14:03.860Z|初めまして P|0:00:00.629 🚩|初めまして|
|2023-11-18T09:14:03.877Z|初めまして PJ|0:00:00.017| |
|2023-11-18T09:14:04.240Z|初めまして PJ です|0:00:00.363| |
|2023-11-18T09:14:05.555Z|初めまして PJ です 京都|0:00:01.315 🚩|PJ です|
|2023-11-18T09:14:05.955Z|初めまして PJ です 京都で|0:00:00.400| |
|2023-11-18T09:14:06.072Z|初めまして PJ です 京都で自然|0:00:00.117| |
|2023-11-18T09:14:06.353Z|初めまして PJ です 京都で自然言|0:00:00.281| |
|2023-11-18T09:14:06.445Z|初めまして PJ です 京都で自然言語|0:00:00.092| |
|2023-11-18T09:14:06.506Z|初めまして PJ です 京都で自然言語処理|0:00:00.061| |
|2023-11-18T09:14:06.721Z|初めまして PJ です 京都で自然言語処理を|0:00:00.215| |
|2023-11-18T09:14:06.921Z|初めまして PJ です 京都で自然言語処理をやって|0:00:00.200| |
|2023-11-18T09:14:07.048Z|初めまして PJ です 京都で自然言語処理をやってい|0:00:00.127| |
|2023-11-18T09:14:07.095Z|初めまして PJ です 京都で自然言語処理をやっています|0:00:00.047| |
|2023-11-18T09:14:08.067Z|初めまして PJ です 京都で自然言語処理をやっています どう|0:00:00.972 🚩|京都で自然言語処理をやっています|
|2023-11-18T09:14:08.127Z|初めまして PJ です 京都で自然言語処理をやっています どうぞ|0:00:00.060| |
|2023-11-18T09:14:08.322Z|初めまして PJ です 京都で自然言語処理をやっています どうぞよろしく|0:00:00.195| |
|2023-11-18T09:14:08.592Z|初めまして PJ です 京都で自然言語処理をやっています どうぞよろしくお願い|0:00:00.270| |
|2023-11-18T09:14:08.677Z|初めまして PJ です 京都で自然言語処理をやっています どうぞよろしくお願いし|0:00:00.085| |
|2023-11-18T09:14:09.087Z|初めまして PJ です 京都で自然言語処理をやっています どうぞよろしくお願いします|0:00:00.410| |
|2023-11-18T09:14:10.629Z|初めまして PJ です 京都で自然言語処理をやっています どうぞよろしくお願いします 以上|0:00:01.542 🚩|どうぞよろしくお願いします|
|2023-11-18T09:14:10.905Z|初めまして PJ です 京都で自然言語処理をやっています どうぞよろしくお願いします 以上です|0:00:00.276| |
|2023-11-18T09:14:11.406Z|初めまして PJ です 京都で自然言語処理をやっています どうぞよろしくお願いします 以上です|0:00:03.007 🚩|以上です|

※ 最終行の transcript は、フロントエンド（クライアント）のタイムアウトによって送信されたもの
